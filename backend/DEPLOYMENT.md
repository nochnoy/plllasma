# Развертывание Plllasma Backend (NestJS)

## Что было создано

✅ **Полноценное NestJS приложение** с базовым функционалом авторизации, копирующим логику из PHP бэкенда.

## Структура проекта

```
backend/
├── src/
│   ├── auth/                    # Модуль авторизации
│   │   ├── dto/login.dto.ts     # DTO для входа
│   │   ├── auth.controller.ts   # Контроллер авторизации
│   │   ├── auth.service.ts      # Сервис авторизации (с БД)
│   │   ├── auth.service.simple.ts # Упрощенный сервис (для тестирования)
│   │   ├── auth.module.ts       # Модуль авторизации (с БД)
│   │   ├── auth.module.simple.ts # Упрощенный модуль
│   │   ├── jwt.strategy.ts      # JWT стратегия
│   │   └── jwt-auth.guard.ts    # JWT guard
│   ├── user/                    # Модуль пользователей
│   │   ├── entities/            # Entity для БД
│   │   │   ├── user.entity.ts
│   │   │   ├── access.entity.ts
│   │   │   └── user-ignore.entity.ts
│   │   ├── user.service.ts      # Сервис пользователей
│   │   └── user.module.ts       # Модуль пользователей
│   ├── app.controller.ts        # Главный контроллер
│   ├── app.service.ts           # Главный сервис
│   ├── app.module.ts            # Главный модуль (с БД)
│   ├── app.module.simple.ts     # Упрощенный модуль
│   └── main.ts                  # Точка входа
├── package.json                 # Зависимости
├── tsconfig.json               # Конфигурация TypeScript
├── nest-cli.json               # Конфигурация NestJS CLI
├── .env                        # Переменные окружения
├── env.example                 # Пример конфигурации
├── test-api.js                 # Тестовый скрипт
└── README.md                   # Документация
```

## Функциональность

### ✅ Реализованная авторизация (копирует PHP логику)

1. **Авторизация по логину/паролю**
   - Прямая проверка в БД (без хеширования, как в оригинале)
   - Генерация GUID токена
   - Сохранение в поле `logkey` таблицы `tbl_users`
   - Установка cookie `contortion_key` на 7 дней

2. **Авторизация по токену из cookies**
   - Восстановление сессии через токен в cookies
   - Обновление токена при каждом входе
   - Защита от брутфорса (задержка 2 секунды)

3. **JWT токены**
   - Дополнительная безопасность поверх cookie токенов
   - Автоматическое обновление при входе по токену

4. **CORS настройки**
   - Идентичны настройкам в PHP бэкенде
   - Поддержка всех доменов проекта

5. **Права доступа**
   - Функции `canRead()`, `canWrite()`, `canTrash()`, `canEditMatrix()`
   - Полностью копируют логику из PHP

## API Endpoints

- `GET /` - Главная страница
- `GET /health` - Проверка здоровья сервиса
- `POST /api/auth/login` - Авторизация (логин/пароль или токен)
- `GET /api/auth/me` - Информация о текущем пользователе
- `POST /api/auth/logout` - Выход из системы

## Запуск

### Режим разработки
```bash
npm run start:dev
```

### Продакшн
```bash
npm run build
npm run start:prod
```

## Конфигурация

Настройте файл `.env`:
```
DB_HOST=localhost
DB_PORT=3306
DB_USER=plllasma
DB_PASSWORD=your_password_here
DB_NAME=plllasma
JWT_SECRET=your-jwt-secret-key-here
NODE_ENV=development
```

## Тестирование

Запустите тестовый скрипт:
```bash
node test-api.js
```

## Переключение между версиями

- **Упрощенная версия** (без БД, для тестирования): использует `*.simple.ts` файлы
- **Полная версия** (с БД): использует основные файлы модулей

Для переключения на полную версию:
1. Измените импорт в `main.ts` с `app.module.simple` на `app.module`
2. Убедитесь что база данных доступна
3. Настройте правильные параметры подключения в `.env`

## Особенности реализации

- **Полная совместимость** с PHP бэкендом по API
- **Идентичная логика** авторизации и проверки прав
- **Современный стек** (NestJS + TypeORM + JWT)
- **Готовность к расширению** - легко добавить новые модули
- **Документированный код** с комментариями на русском языке
