<ng-container *ngFor="let message of messages">
  <div class="branch"
       [class.branch-root]="!message.parent"
       [class.msg-starred]="message.isStarred"
       *ngIf="message != null">

    <ng-container [ngSwitch]="message.display">

      <!-- –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (MessageDisplayType.NORMAL) -->
      <div *ngSwitchCase="0"
           class="message"
           [class.message__selected]="message === channelService.selectedMessage"
           [class.message__editing]="message === channelService.selectedMessage && channelService.selectedMessageEditing"
           [class.message__hover-by-child]="message.isHoverByChild"
           (mouseenter)="onMessageHover(message, true)"
           (mouseleave)="onMessageHover(message, false)"
           (click)="onMessageClick(message)">

        <img class="avatar" [src]="'https://plllasma.com/i/' + message.icon +'.gif'" />
        <a class="nick"
           [routerLink]="'/members/' + message.nick"
           target="_blank"
           [class.star]="message.isStarred">{{message.nick}}</a>

        <!-- –û—Ä–∏–≥–∏–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è —é–∑–µ—Ä –ù–ï –≤–∏–¥–∏—Ç –∫–æ–≥–¥–∞ –≤—ã–¥–µ–ª–∏—Ç —Å–≤–æ—ë —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
        <ng-container *ngIf="!(message === channelService.selectedMessage && channelService.selectedMessageEditing)">
          <p *ngIf="!!message.text" [innerHTML]="message.text | linky | newline"></p>
        </ng-container>
        <!-- –Æ–∑–µ—Ä –≤—ã–¥–µ–ª–∏–ª —Å–≤–æ—ë —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–∫–∞–∂–µ–º –µ–≥–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. -->
        <p *ngIf="message === channelService.selectedMessage && channelService.selectedMessageEditing"
           class="editable" tabindex="1" autofocus contenteditable="true" [(ngModel)]="message.text"></p>

        <div *ngIf="message.attachments">
          <a *ngFor="let attachment of message.attachments"
             class="attachment" target="_blank"
             [href]="'../api/file.php?p=' + this.placeId + '&m=' + this.message.id + '&a=' + attachment.id">
            <img [src]="'../api/i.php?p=' + this.placeId + '&m=' + this.message.id + '&a=' + attachment.id" loading="lazy" />
          </a>
        </div>

        <div class="likes" (click)="onMessageClick(message)" *ngIf="message !== channelService.selectedMessage">
          <span *ngIf="message.sps">—Å–ø—Å{{message.sps}}</span>
          <span *ngIf="message.heh">—Ö–µ{{message.heh}}</span>
          <span *ngIf="message.nep">–Ω–µ–ø{{message.nep}}</span>
          <span *ngIf="message.ogo">–û–ì–û{{message.ogo}}</span>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —á—É–∂–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –ª–∞–π–∫–∏, –æ—Ç–≤–µ—Ç, —Ç–¥ -->
        <ng-container *ngIf="message === channelService.selectedMessage && !channelService.selectedMessageEditing">

          <div class="message-actions" [class.liked]="!!message.myLike">
            <a href class="like-button" [class.selected]="message.myLike === 'sps'" (click)="onLikeClick($event, message, 'sps')" title="–°–ø–∞—Å–∏–±–∞">üëç<ng-container *ngIf="message.sps"> {{message.sps}}</ng-container></a>
            <a href class="like-button" [class.selected]="message.myLike === 'heh'" (click)="onLikeClick($event, message, 'heh')" title="–•–µ-—Ö–µ">üòÑ<ng-container *ngIf="message.heh"> {{message.heh}}</ng-container></a>
            <a href class="like-button" [class.selected]="message.myLike === 'nep'" (click)="onLikeClick($event, message, 'nep')" title="–ù–µ–ø–æ–Ω—è—Ç–Ω–æ">ü§î<ng-container *ngIf="message.nep"> {{message.nep}}</ng-container></a>
            <a href class="like-button" [class.selected]="message.myLike === 'ogo'" (click)="onLikeClick($event, message, 'ogo')" title="–û–ì–û">üòµ<ng-container *ngIf="message.ogo"> {{message.ogo}}</ng-container></a>
            <div class="message-date">{{message.timeCreated | plasmadate}}</div>
          </div>

          <div class="reply">
            <app-message-form-2 [channelId]="placeId"
                                [parentMessage]="message"
                                [replyMode]="true"
                                (onPost)="onNewMessageCreated()">
            </app-message-form-2>
          </div>

        </ng-container>

        <!-- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div  class="tools-edit" *ngIf="message === channelService.selectedMessage && channelService.selectedMessageEditing">
          <ng-container *ngIf="!isSending">
            <a href (click)="onCancelEditClick($event)">–û—Ç–º–µ–Ω–∏—Ç—å</a>
            <button (click)="onSaveEditClick()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </ng-container>
          <div class="spinner" *ngIf="isSending">–ó–∞–≥—Ä—É–∑–∫–∞</div>
        </div>

      </div>

      <!-- –°–µ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (MessageDisplayType.GRAY) -->
      <div *ngSwitchCase="1"
           class="message message-gray"
           [class.message__hover-by-child]="message.isHoverByChild"
           (mouseenter)="onMessageHover(message, true)"
           (mouseleave)="onMessageHover(message, false)"
           (click)="unfoldGray($event, message)">

        <img class="avatar" [src]="'https://plllasma.com/i/' + message.icon +'.gif'">
        <a class="nick"
           [routerLink]="'/members/' + message.nick"
           target="_blank"
           [class.star]="message.isStarred">{{message.nick}}</a>
        <p *ngIf="!!message.text" [innerHTML]="message.text | linky: true | linksToStubs | shorten"></p>

        <div *ngIf="message.attachments">
          <a *ngFor="let attachment of message.attachments"
             class="attachment" target="_blank"
             [href]="'../api/file.php?p=' + this.placeId + '&m=' + this.message.id + '&a=' + attachment.id">
            <img [src]="'../api/i.php?p=' + this.placeId + '&m=' + this.message.id + '&a=' + attachment.id" loading="lazy" />
          </a>
        </div>

      </div>

      <!-- –°—Ö–ª–æ–ø (MessageDisplayType.SHLOP) -->
      <a href *ngSwitchCase="10"
            class="message message-gray expand" (click)="unshlop($event, message)">
        {{(message | as : ShlopMessageRef).shlop.lengthText}}
      </a>

    </ng-container><!-- ngSwitch -->

    <app-messages *ngIf="showChildren && message.children && message.children.length > 0" [placeId]="placeId" [messages]="message.children"></app-messages>

  </div>
</ng-container>
