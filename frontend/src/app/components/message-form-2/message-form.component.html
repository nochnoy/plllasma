<div class="form"
     (dragover)="onDragOver($event)"
     (dragleave)="onDragLeave($event)"
     (drop)="onDropSuccess($event)"
     (dragend)="onDragEnd()"
     [class.form--empty]="!messageText"
     [class.form--ghost]="isGhost"
     [class.form--reply]="replyMode"
     [class.form--drop]="isDragging">

  <div class="user-input" (click)="onUserLineClick()">
    <div class="user" (click)="onGhostClick()">
      <ng-container *ngIf="!isGhost">
        <img class="avatar" [src]="'https://plllasma.com/i/' + userIcon" />{{userName}}▾
      </ng-container>
      <ng-container *ngIf="isGhost">
        <div class="icon"></div>{{'Привидение'}}▴
      </ng-container>
    </div>
  </div>

  <textarea
    #textarea
    class="message-textarea"
    [(ngModel)]="messageText"
    (input)="onTextareaInput($event)"
    (paste)="onPaste($event)"
    rows="1">
  </textarea>

  <div class="tools">
    <div class="tools-attach">
      <div class="attachments" *ngIf="attachments && attachments.length">
        <div *ngFor="let attachment of attachments" class="attachment" [class.attachment--error]="attachment.error">
          <div class="attachment-icon" *ngIf="!attachment.isImage"></div>
          <img class="attachment-thumb" *ngIf="attachment.isImage" [src]="attachment.bitmap" />
          <span class="attachment-name" [title]="attachment.file.name">{{attachment.file.name}}</span>
          
          <!-- Прогрессбар для chunked upload -->
          <div class="attachment-progress-container" *ngIf="attachment.isChunked && attachment.uploadStatus && attachment.uploadStatus !== 'completed'">
            <div class="attachment-progress-bar">
              <div class="attachment-progress-fill" 
                   [style.width.%]="attachment.progress || 0"
                   [class.paused]="attachment.uploadStatus === 'paused'"
                   [class.error]="attachment.uploadStatus === 'error'"
                   [class.completing]="attachment.uploadStatus === 'completing'">
              </div>
            </div>
            <span class="attachment-progress-text">
              <ng-container *ngIf="attachment.uploadStatus === 'uploading'">{{attachment.progress}}%</ng-container>
              <ng-container *ngIf="attachment.uploadStatus === 'paused'">Пауза</ng-container>
              <ng-container *ngIf="attachment.uploadStatus === 'completing'">Завершение...</ng-container>
              <ng-container *ngIf="attachment.uploadStatus === 'error'">Ошибка</ng-container>
            </span>
          </div>
          
          <!-- Кнопки управления для chunked upload -->
          <div class="attachment-controls" *ngIf="attachment.isChunked && (attachment.uploadStatus === 'uploading' || attachment.uploadStatus === 'paused')">
            <button class="attachment-control-btn pause" 
                    *ngIf="attachment.uploadStatus === 'uploading'"
                    (click)="onPauseClick(attachment)" 
                    title="Пауза"></button>
            <button class="attachment-control-btn resume" 
                    *ngIf="attachment.uploadStatus === 'paused'"
                    (click)="onResumeClick(attachment)" 
                    title="Продолжить"></button>
          </div>
          
          <span class="attachment-error" *ngIf="attachment.error">{{attachment.error}}</span>
          <span class="attachment-remove" (click)="onremoveClick(attachment)" title="Удалить">✕</span>
        </div>
      </div>
      <div class="tools-attach-buttons">
        <button (click)="onAddAttachmensClick()"
                (mouseover)="dnd.hidden = false"
                (mouseout)="dnd.hidden = true"
                [disabled]="isSending || isUploading">+
        </button>
        <label>Файлы<span #dnd hidden="hidden">. Можно драг-н-дропом. До 1 GB.</span></label>
      </div>
    </div>
    <div  class="tools-send">
      <a href *ngIf="replyMode && !isUploading" (click)="onCancelEditClick($event)">Отменить</a>
      <button *ngIf="!isSending && !isUploading" (click)="onSendClick()">{{replyMode ? 'Ответить' : 'Отправить'}}</button>
      <div class="spinner" *ngIf="isSending">Отправка</div>
      <div class="spinner" *ngIf="isUploading && !isSending">Загрузка файлов...</div>
    </div>
  </div>
</div>
