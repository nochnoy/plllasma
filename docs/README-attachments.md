# Новая система аттачментов для PLLLasma

## Что реализовано

✅ **Полностью готовая система аттачментов для YouTube ссылок**

### Основные возможности:
- Автоматическое обнаружение YouTube ссылок в сообщениях
- Создание аттачментов с уникальными GUID
- Переиспользование существующих аттачментов
- Отображение аттачментов под сообщениями
- Страница просмотра аттачментов с разными статусами
- Параллельная работа со старой системой аттачментов

### Статусы аттачментов:
- `pending` - создан, но не обработан (редирект на YouTube)
- `unavailable` - контент недоступен (показ превью с сообщением)
- `ready` - готов к просмотру (заглушка для будущего видеоплеера)

## Быстрый старт

### 1. Выполните миграцию БД

```bash
# Выполните SQL из файла db/migration_attachments.sql
mysql -u plllasma -p plllasma < db/migration_attachments.sql
```

### 2. Протестируйте систему

```bash
# Запустите тестовый скрипт
php scripts/test-attachments.php
```

### 3. Проверьте работу

1. Откройте любой канал
2. Отправьте сообщение с YouTube ссылкой
3. Убедитесь, что аттачмент появился под сообщением
4. Кликните на аттачмент - должно открыться YouTube в новой вкладке

## Структура изменений

### Backend (PHP)
- `api/include/functions-attachments.php` - основные функции
- `api/message-add.php` - модифицирован для обработки YouTube ссылок
- `api/message-edit.php` - модифицирован для обработки YouTube ссылок
- `api/include/functions-channel.php` - обновлен для передачи полных данных аттачментов
- `api/attachment-get.php` - API для получения информации об аттачменте по ID

### Frontend (Angular)
- `frontend/src/app/components/attachment-item/` - компонент для отображения отдельного аттачмента
- `frontend/src/app/pages/attachment-page/` - страница просмотра аттачмента
- `frontend/src/app/modules/shared/pipes/linky.pipe.ts` - убрана обработка YouTube
- `frontend/src/app/model/messages/message.model.ts` - добавлено поле newAttachments
- `frontend/src/app/components/messages/messages.component.html` - интегрированы новые аттачменты в существующий контейнер

### База данных
- Добавлен столбец `json` в таблицу `tbl_messages`
- Создана таблица `attachments` для хранения информации об аттачментах

## API

### Автоматическая обработка
- При отправке сообщения с YouTube ссылками автоматически создаются аттачменты
- При редактировании сообщения переиспользуются существующие аттачменты
- Полные данные аттачментов передаются вместе с сообщениями (без дополнительных запросов)

### Получение информации об аттачменте
```
GET /api/attachment-get.php?id={guid}
```

## Что дальше

### Следующие этапы:
1. **Воркер для обработки** - создание иконок и превью для аттачментов
2. **Видеоплеер** - встраивание YouTube видео на страницу
3. **Другие типы** - поддержка файлов, изображений, видео
4. **Управление** - удаление, редактирование аттачментов

### Для воркера потребуется:
- Скачивание превью с YouTube API
- Создание иконок разных размеров
- Обновление статусов аттачментов
- Обработка ошибок (видео недоступно)

### Логика переиспользования:
- Каждое сообщение имеет свои собственные аттачменты
- Один и тот же YouTube ролик может быть в разных сообщениях как отдельные аттачменты
- При редактировании сообщения переиспользуются только аттачменты этого же сообщения

## Архитектура компонентов

### Новый подход (реализован)
- **`AttachmentItemComponent`** - компонент для отображения отдельного аттачмента
- Интеграция в существующий контейнер сообщений
- Единообразный интерфейс для старых и новых аттачментов
- Каждый аттачмент загружает свои данные независимо

### Преимущества новой архитектуры
- **Единообразие**: новые и старые аттачменты выглядят одинаково
- **Модульность**: каждый аттачмент - отдельный компонент
- **Производительность**: данные аттачментов передаются вместе с сообщениями (без дополнительных запросов)
- **Масштабируемость**: легко добавлять новые типы аттачментов

## Тестирование

### Тестовые YouTube ссылки:
```
https://www.youtube.com/watch?v=dQw4w9WgXcQ
https://youtu.be/dQw4w9WgXcQ
https://www.youtube.com/shorts/dQw4w9WgXcQ
https://youtube.com/embed/dQw4w9WgXcQ
```

### Проверьте:
1. Создание аттачментов при отправке сообщения
2. Переиспользование при редактировании
3. Отображение в списке сообщений
4. Переход на страницу просмотра
5. Редирект на YouTube для pending статуса

## Примечания

- Система работает параллельно со старой
- YouTube ссылки в тексте теперь обычные ссылки (без превью)
- Аттачменты создаются только для новых/редактируемых сообщений
- GUID обеспечивает уникальность аттачментов
- Структура папок для аттачментов: `attachments/new/{first2}/{next2}/{guid}/`

## Поддержка

При возникновении проблем:
1. Проверьте логи PHP
2. Убедитесь, что миграция БД выполнена
3. Проверьте права доступа к папке attachments
4. Запустите тестовый скрипт для диагностики
